<!DOCTYPE html>
<title>Telegraph Graph Editor</title>

<head>
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="/telegraph/lib/nv.d3.css">
  <link rel="stylesheet" type="text/css" href="/telegraph/style.css">

  <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.js"></script>

  <script src="/telegraph/lib/nv.d3.js"></script>
  <script src="/telegraph/telegraph.js"></script>
  <script src="/telegraph/table.js"></script>
  <script src="/telegraph/config.js"></script>

  <script>
    var telegraph;
    var targets = new Table("#targets", targetCells, function(targets) {
      telegraph.targets = targets.items;
      redraw();
    });
    _.bindAll(targets)

    load();
    $(window).on("hashchange", function () { load() });

    function targetCells(target) {
      var sub = $("#variables").is(":focus") ? _.identity : telegraph.subVariables;

      var query = sub(target.query);
      var shift = sub(target.shift);

      var labelField = $("<span/>", {text: target.label, contenteditable: true})
      blurOnEnter(labelField);
      labelField.blur(function(e) {
        var newLabel = $(this).text();
        if (newLabel != target.label) {
          target.label = newLabel;
          redraw();
        }
      });

      var cells = [
        {html: labelField},
        {class: "monospace", html: $("<a/>", {text: query}).click(_.partial(fillQuery, target))},
        {class: "monospace", text: shift}
      ]
      var chart = $("#chart").val();

      if (chart == "multiChart") {
        cells.push({text: target.type});
        cells.push({html: (target.yAxis == 1 ? "&larr;" : "&rarr;")});
      } else if (chart == "linePlusBarChart") {
        cells.push({text: target.bar || "line"});
      }
      return cells;
    };

    function displayHeader() {
      $("#name").text(telegraph.name);
      $("#graph-header").css({display: telegraph.name ? "block" : "none"});
    };

    function redraw(name) {
      telegraph.draw("#graph", displayHeader);
      telegraph.hasVariables() ? $("#variables").show() : $("#variables").hide();

      $("#refresh").show();
      var chart = $("#chart").val();
      display(".multi", chart == "multiChart");
      display(".line-plus-bar", chart == "linePlusBarChart");
    };

    function fillQuery(target) {
      $("#query").val(target.query);
      $("#baseUrl").val(target.baseUrl);
      $("#shift").val(target.shift);
      $("#bar").val(target.bar);
      $("#type").val(target.type);
      $("#yAxis").val(target.yAxis);
    };

    function display(selector, show) {
      $(selector).css({display: show ? "inline-block" : "none"})
    };

    function save() {
      telegraph.save({
        success: function(results) {
          showAlert(results.name + " saved");
          displayHeader();
        },
        error: function(error) {
          if (confirm(error + " Would you like to overwrite?")) {
            telegraph.save({force: true});
          }
        }
      });
    };

    function pushHistory(name) {
      history.pushState(name, "", window.location.pathname + (name ? "#" + name : ""));
    };

    function showAlert(text, type) {
      if (type) type = "alert-" + type;
      $("#alerts").append($("<div/>", {class: "alert fade in " + type, text: text}));
      setTimeout(function() { $(".alert").alert('close'); }, 3000);
    };

    function hash() {
      return window.location.hash.substr(1)
    };

    function load(name) {
      Telegraph.load(name == null ? hash() : name, function(t) {;
        telegraph = t;
        _.bindAll(telegraph);

        if (name != null) pushHistory(telegraph.name);
        $("#from").val(telegraph.from);
        $("#until").val(telegraph.until);
        $("#chart").val(telegraph.chart);
        $("#variables").val(JSON.stringify(telegraph.variables));

        targets.replace(telegraph.targets);
      }, function(name) { showAlert("no such graph: " + name) });
    };

    function blurOnEnter(selector) {
      $(selector).keydown(function(e) {
        if(e.keyCode == 13) $(this).blur();
      });
    };

    $(document).ready(function() {
      $("#add").click(function() {
        var query = $("#query").val();
        var shift = $("#shift").val();
        targets.add({
          label:    _.compact([shift, query]).join(":"),
          query:    query,
          shift:    shift,
          baseUrl:  $("#baseUrl").val(),
          bar:      $("#bar").val(),
          type:     $("#type").val(),
          yAxis:    $("#yAxis").val()
        });
      });

      $("#refresh").click(function() {
        telegraph.update();
      });

      $("#from").change(function() {
        telegraph.from = $(this).val();
        redraw();
      });

      $("#until").change(function() {
        telegraph.until = $(this).val();
        redraw();
      });

      $("#chart").change(function() {
        telegraph.chart = $(this).val();
        redraw();
      });

      $("#variables").change(function() {
        var variables = $("#variables").val();
        telegraph.variables = variables ? JSON.parse(variables) : null
        redraw();
        targets.update();
      });

      $("#variables").focus(function() {
        $(this).css({height: "78px"});
        targets.update();
      });

      $("#variables").blur(function() {
        $(this).css({height: "21px"});
        targets.update();
      });

      $("#name").blur(function() {
        telegraph.name = $(this).text();
        telegraph.version = null;
        $(this).attr({contenteditable: false});
      });

      blurOnEnter("#name");

      $("#save").click(function() {
        telegraph.name = telegraph.name || prompt("Save graph as:");
        save();
      });

      $("#duplicate").click(function() {
        $("#name").attr({contenteditable: true}).text(telegraph.name + " copy").focus();
        $("#graph-menu").dropdown("toggle");
        document.execCommand("selectAll",false,null);
        return false;
      });

      $("#close").click(function() {
        load("");
        return false;
      });

      $("#load").click(function() {
        var name = prompt("Load graph:");
        load(name);
      });

      var $select = $("#baseUrl");
      _.each(telegraphBaseUrls, function (base) {
        $select.append('<option value=' + base.url + '>' + base.label + '</option>');
      });
    });
  </script>
</head>

<body>
  <div id="edit-container" class="clearfix">
    <div id="query-container">
      <select id="baseUrl"></select>
      <textarea id="query"></textarea>
      <div id="query-options">
        <input type="text" id="shift" placeholder="timeshift">
        <span class="line-plus-bar">
          <select id="bar">
            <option value="">line</option>
            <option value="bar">bar</option>
          </select>
        </span>

        <span class="multi">
          <select id="type">
            <option value="line">line</option>
            <option value="bar">bar</option>
            <option value="area">area</option>
          </select>
          <select id="yAxis">
            <option value="1">left</option>
            <option value="2">right</option>
          </select>
        </span>
        <div class="buttons">
          <span id="add" class="btn">Add</span>
        </div>
      </div>
    </div>

    <div id="list-container">
      <table id="targets" class="table table-striped">
      </table>
      <div id="graph-options">
        <input type="text" id="from" placeholder="-24h">
        <input type="text" id="until" placeholder="">
        <select id="chart">
          <option value="lineChart">line</option>
          <option value="stackedAreaChart">stacked area</option>
          <option value="multiBarChart">multi bar</option>
          <option value="linePlusBarChart">line plus bar</option>
          <option value="multiChart">multi</option>
          <option value="lineWithFocusChart">line with viewfinder</option>
          <option value="cumulativeLineChart">cumulative line</option>
        </select>
        <textarea id="variables" placeholder="macro variables"></textarea>
        <div class="buttons">
          <span id="load" class="btn">Load</span>
          <span id="save" class="btn">Save</span>
        </div>
      </div>
    </div>
  </div>

  <div id="graph-container">
    <div id="alerts"></div>
    <div id="graph-header">
      <span id="refresh">
        <img class="icon" src="/telegraph/images/refresh.svg">
      </span>

      <div id="graph-title" class="dropdown">
        <span id="graph-name" class="dropdown-toggle" data-toggle="dropdown">
          <img class="icon" src="/telegraph/images/graph.svg">
          <span id="name"></span>
        </span>
        <ul id="graph-menu" class="dropdown-menu" role="menu">
          <li><a id="rename"    href="#">Rename</a></li>
          <li><a id="duplicate" href="#">Duplicate</a></li>
          <li><a id="close"     href="#">Close</a></li>
          <li class="divider"></li>
          <li><a id="delete"    href="#">Delete</a></li>
        </ul>
      </div>
    </div>

    <div id="graph" class="chart">
      <svg></svg>
    </div>
  </div>
</body>
