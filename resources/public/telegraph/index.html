<!DOCTYPE html>
<title>Telegraph Graph Editor</title>

<head>
  <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css">
  <link rel="stylesheet" type="text/css" href="/telegraph/lib/nv.d3.css">
  <link rel="stylesheet" type="text/css" href="/telegraph/style.css">

  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.js"></script>

  <script src="/telegraph/lib/nv.d3.js"></script>
  <script src="/telegraph/telegraph.js"></script>
  <script src="/telegraph/config.js"></script>

  <script>
    var targets = [];

    var chart = nv.models.lineChart();
    chart.xAxis.tickFormat(function(d){ return d3.time.format('%X')(new Date(d * 1000)) });
    chart.yAxis.tickFormat(d3.format('d'));

    var telegraph = new Telegraph(".graph", chart, {
      from:  $("#from").val()  || "-24h",
      until: $("#until").val() || "0h"
    });

    function redrawChart() {
      telegraph.update(targets);
    };

    function removeTarget(e) {
      var link = $(this);
      link.parents("tr").remove();
      targets[link.attr("targetId")] = null;
      redrawChart();
    };

    function addTarget(e) {
      var id      = targets.length;
      var label   = $("#label").val();
      var query   = $("#query").val();
      var shift   = $("#shift").val();
      var name    = label || _.compact([shift, query]).join(":");
      var baseUrl = $("#baseUrl").val();

      targets.push({
        name:     name,
        query:    query,
        shift:    shift || '0h',
        baseUrl:  baseUrl
      });

      var queryLink  = $("<a/>", {text: query}).on("click", function() {
        $("#label").val(label);
        $("#query").val(query);
        $("#baseUrl").val(baseUrl);
        $("#shift").val(shift);
      });
      var removeLink = $("<a/>", {text: "remove", targetId: id}).on("click", removeTarget);
      var row = $("<tr/>").append($("<td/>", {text: name}))
                          .append($("<td/>").html(queryLink))
                          .append($("<td/>", {text: shift}))
                          .append($("<td/>").html(removeLink));
      $(".targets").append(row);

      redrawChart();
    }

    $(document).ready(function() {
      $("#add").click(addTarget);
      $("#redraw").click(redrawChart);

      var $select = $("#baseUrl");
      _.each(telegraphBaseUrls, function (base) {
        $select.append('<option value=' + base.url + '>' + base.label + '</option>');
      });
    });
  </script>
</head>

<body>
  <div id="add-container">
    <form>
      <select id="baseUrl"></select>
      <input type="text" id="label" placeholder="Query Name">
      <textarea id="query"></textarea>
      <input type="text" id="shift" placeholder="timeshift">
      <button type="button" id="add" class="button">Add</button>
    </form>
  </div>
  <div id="list-container">
    <table class="targets table table-striped">
    </table>
  </div>

  <div id="graph-container">
    <form>
      <input type="text" id="from" placeholder="-24h">
      <input type="text" id="until" placeholder="">
      <button type="button" id="redraw" class="button">Redraw</button>
    </form>
    <div class="chart graph">
      <svg></svg>
    </div>
  </div>
</body>
