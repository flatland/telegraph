<!DOCTYPE html>
<title>Telegraph Graph Editor</title>

<head>
  <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css">
  <link rel="stylesheet" type="text/css" href="/telegraph/lib/nv.d3.css">
  <link rel="stylesheet" type="text/css" href="/telegraph/style.css">

  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.js"></script>

  <script src="/telegraph/lib/nv.d3.js"></script>
  <script src="/telegraph/telegraph.js"></script>
  <script src="/telegraph/config.js"></script>

  <script>
    var targets = [];
    var telegraph;

    function redrawChart() {
      $(".graph svg").text("");

      var variables = $("#variables").val();

      telegraph = new Telegraph(".graph", {
        from:  $("#from").val(),
        until: $("#until").val(),
        chart: $("#chart").val(),
        targets: targets,
        variables: variables ? JSON.parse(variables) : null
      });

      displayChartOptions();
    };

    function updateChart() {
      telegraph.update();
    };

    function removeTarget(e) {
      var link = $(this);
      link.parents("tr").remove();
      targets[link.attr("targetId")] = null;
      redrawChart();
    };

    function addTarget(target) {
      var id = targets.length;
      targets.push(target);

      var queryLink  = $("<a/>", {text: target.query}).on("click", function() {
        $("#label").val(target.label);
        $("#query").val(target.query);
        $("#baseUrl").val(target.baseUrl);
        $("#shift").val(target.shift);
        $("#bar").val(target.bar);
        $("#type").val(target.type);
        $("#yAxis").val(target.yAxis);
      });
      var removeIcon = $("<img/>", {src: "/telegraph/images/x.gif"});
      var removeLink = $("<span/>", {id: "remove", targetId: id}).html(removeIcon).on("click", removeTarget);
      var row = $("<tr/>").append($("<td/>", {text: target.label}))
                          .append($("<td/>").html(queryLink))
                          .append($("<td/>", {class: "multi", text: target.type}))
                          .append($("<td/>", {class: "multi"}).html(target.yAxis == 1 ? "&larr;" : "&rarr;"))
                          .append($("<td/>", {class: "line-plus-bar", text: target.bar || "line"}))
                          .append($("<td/>", {text: target.shift}))
                          .append($("<td/>").html(removeLink));
      $(".targets").append(row);
    };

    function display(selector, show) {
      show ? $(selector).removeClass("hidden") : $(selector).addClass("hidden");
    };

    function hasVariables() {
      return _.some(targets, function(t) { return t.query.match(/\$/) });
    };

    function displayChartOptions() {
      var chart = $("#chart").val();
      display(".multi", chart == "multiChart");
      display(".line-plus-bar", chart == "linePlusBarChart");

      hasVariables() ? $("#variables").show() : $("#variables").hide();
    };

    $(document).ready(function() {
      $("#add").click(function() {
        addTarget({
          label:    $("#label").val(),
          query:    $("#query").val(),
          shift:    $("#shift").val(),
          baseUrl:  $("#baseUrl").val(),
          bar:      $("#bar").val(),
          type:     $("#type").val(),
          yAxis:    $("#yAxis").val()
        });
        redrawChart();
      });

      $("#refresh").click(updateChart);
      $("#from").on("change", redrawChart);
      $("#until").on("change", redrawChart);
      $("#chart").on("change", redrawChart);
      $("#variables").on("change", redrawChart);

      $("#save").click(function() {
        console.log(telegraph);
      });

      var $select = $("#baseUrl");
      _.each(telegraphBaseUrls, function (base) {
        $select.append('<option value=' + base.url + '>' + base.label + '</option>');
      });
    });
  </script>
</head>

<body>
  <div id="add-container">
    <select id="baseUrl"></select>
    <input type="text" id="label" placeholder="label">
    <textarea id="query"></textarea>
    <input type="text" id="shift" placeholder="timeshift">
    <span class="line-plus-bar hidden">
      <select id="bar">
        <option value="">line</option>
        <option value="bar">bar</option>
      </select>
    </span>
    <span class="multi hidden">
      <select id="type">
        <option value="line">line</option>
        <option value="bar">bar</option>
        <option value="area">area</option>
      </select>
      <select id="yAxis">
        <option value="1">left</option>
        <option value="2">right</option>
      </select>
    </span>
    <div id="buttons">
      <span id="add" class="btn">Add</span>
    </div>
  </div>

  <div id="list-container">
    <div id="graph-options">
      <input type="text" id="from" placeholder="-24h">
      <input type="text" id="until" placeholder="">
      <select id="chart">
        <option value="lineChart">line</option>
        <option value="stackedAreaChart">stacked area</option>
        <option value="multiBarChart">multi bar</option>
        <option value="linePlusBarChart">line plus bar</option>
        <option value="multiChart">multi</option>
        <option value="lineWithFocusChart">line with viewfinder</option>
        <option value="cumulativeLineChart">cumulative line</option>
      </select>
      <span id="refresh">
        <img id="refresh-icon" src="/telegraph/images/refresh.gif">
      </span>
      <div id="buttons">
        <span id="save" class="btn">Save</span>
      </div>

      <table class="targets table table-striped">
      </table>

      <textarea id="variables"></textarea>
    </div>
  </div>

  <div id="graph-container">
    <div class="chart graph">
      <svg></svg>
    </div>
  </div>
</body>
